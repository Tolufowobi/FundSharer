
@using System.Security.Claims
@using Microsoft.AspNet.Identity
@using FundSharer.Models

@if (Request.IsAuthenticated)
{
    ViewBag.Title = "Home";
    var identity = (ClaimsIdentity)User.Identity;
    var Fname = identity.FindFirstValue(ClaimTypes.GivenName);

    <div class="container">
        <div class="navbar"><h4>Hi there, @Fname !</h4></div>

        <div class="panel-group" id="accordion">

            @*Personal Information summary*@
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse0">Personal Information</a>
                    </h3>
                </div>
                <div id="collapse0" class="panel-collapse collapse in">
                    <div class="panel-body">
                        <div class="text-info">
                            <dl class="dl-horizontal">
                                <dt>@Html.Label("First Name:")</dt>
                                <dd>@Html.DisplayText((string)ViewBag.FirstName)</dd>
                                <dt>@Html.Label("Last Name:")</dt>
                                <dd>@Html.DisplayText((string)ViewBag.LastName)</dd>
                                <dt>@Html.Label("Phone Number:")</dt>
                                <dd>@Html.DisplayText((string)ViewBag.PhoneNumber)</dd>
                                <dt>@Html.Label("Email Address:")</dt>
                                <dd>@Html.DisplayText((string)ViewBag.EmailAddress)</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            @*Account Details*@
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">Your Account Details</a>
                    </h3>
                </div>
                <div id="collapse1" class="panel-collapse collapse">
                    <div class="panel-body">
                        @{ BankAccount Accountdetails = ViewBag.AccountDetails;}
                        @Html.Partial("_AccountDetails", Accountdetails)
                    </div>
                </div>
            </div>

            @*Pending incoming Donations*@
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse2">Your Pending Incoming Donations</a>
                    </h3>
                </div>
                <div id="collapse2" class="panel-collapse collapse">
                    <div class="panel-body">
                        @{ List<Donation> PendingIncomingDonations = ViewBag.PendingIncomingDonations;}
                        @{ List<Payment> PendingIncomingPayments = ViewBag.PendingIncomingPayments;}
                        <div class="text-info">
                            <table class="table-striped">
                                <thead>
                                    <tr>
                                        <td>Match Date</td>
                                        <td>Donor Name</td>
                                        <td>Payment Date</td>
                                        <td>Status</td>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        @if (PendingIncomingDonations.Count() > 0)
                                        {
                                            foreach (Donation d in PendingIncomingDonations)
                                            {
                                                <td>@Html.DisplayFor(model => d.CreationDate.ToShortDateString())</td>
                                                    <td>@Html.DisplayFor(model => d.Donor.AccountTitle)</td>
                                                Payment p = PendingIncomingPayments.Where(m => m.DonationPack.Id == d.Id).FirstOrDefault();
                                                if (p != null)
                                                {
                                                    <td>@Html.DisplayFor(m => p.CreationDate.ToShortDateString())</td>
                                                        <td>
                                                            @if (p.Confirmed == false)
                                                            {
                                                                using (Html.BeginForm("ConfirmPayment", "Payments", new { p.Id }, FormMethod.Get))
                                                                {
                                                                    <input type="submit" class=" btn btn-primary" value="Confirm Payment" />
                                                                }
                                                            }
                                                            else
                                                            {
                                                                <text>Confirmed.</text>
                                                            }
                                                        </td>
                                                }
                                                else
                                                {
                                                    <td>-</td>
                                                    <td>-</td>
                                                }

                                            }
                                        }
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            @*Pending outgoing donation*@
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse3">Donate</a>
                    </h3>
                </div>
                <div id="collapse3" class="panel-collapse collapse in">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6" id="Change">
                                @{ Donation Donation = ViewBag.PendingOutgoingDonation;}
                                @if (Donation != null)
                                {
                                    Html.Partial("_DonationDetails", Donation);
                                }
                                else
                                {
                                    using (Ajax.BeginForm("FindAMatch", new AjaxOptions { HttpMethod = "post", InsertionMode = InsertionMode.Replace, UpdateTargetId = "Change", }))
                                    {
                                        <input type="submit" class="btn btn-primary" value="Find a Match" />
                                    }
                                }
                            </div>
                            <div class="col-md-6">
                                @{Payment Pay = ViewBag.PendingOutgoingPayment;}
                                @if (Pay != null)
                                {
                                    Html.Partial("_PaymentDetails", Pay);
                                }
                                else
                                {
                                    using (Html.BeginForm("UploadPaymentInfo", "Payments", new { Pay.Id }, FormMethod.Get))
                                    {
                                        <input type="submit" class="btn btn-primary" value="Upload Payment" />
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @*Incoming payments history*@
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse4">Here are the past payments you have received</a>
                    </h3>
                </div>
                <div id="collapse4" class="panel-collapse collapse in">
                    <div class="panel-body">
                        @{List<Payment> IncomingPayments = ViewBag.IncomingPayments;}
                        @Html.Partial("_PaymentList", IncomingPayments)
                    </div>
                </div>
            </div>

            @*Outgoing payments history*@
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse5">Here are the past payments you have made</a>
                    </h3>
                </div>
                <div id="collapse5" class="panel-collapse collapse">
                    <div class="panel-body">
                        @{ List<Payment> OutgoingPayments = ViewBag.OutgoingPayments;}
                        @Html.Partial("_PaymentList", OutgoingPayments)
                    </div>
                </div>
            </div>

        </div>
    </div>
    <p>
        @Html.ActionLink("Edit", "Edit", new { /* id = Model.PrimaryKey */ }) |
        @Html.ActionLink("Back to List", "Index")
    </p>

    @section Scripts{
        <script src="~/Scripts/jquery.unobtrusive-ajax.js"></script>
    }
                            }
                            else
                            {
                                @Html.Action("Login", "Account");
                            }
